{"version":3,"file":"animate.js","names":["MC","MH","iterateAnimations","resetCssAnimationsNow","hasClass","addClassesNow","removeClasses","removeClassesNow","isPageReady","waitForPageReady","formatAsString","registerAction","debug","Animate","element","_classCallCheck","_defineProperty","logger","Logger","name","concat","animate","GO_FORWARD","isFirst","undo","GO_BACKWARD","S_TOGGLE","res","GO_TOGGLE","_createClass","key","value","register","direction","isInitial","arguments","length","undefined","debug8","animation","setupAnimation","setupAnimationLegacy","pauseTillReady","isBackward","playbackRate","debug9","playState","reverse","play","pause","then","isInstanceOf","CSSAnimation","cancelHandler","event","onAnimationCancel","addEventListener","S_CANCEL","removeEventListener","_MH$targetOf","target","targetOf","Animation","effect","KeyframeEffect","_iterator","_createForOfIteratorHelper","getAnimations","_step","s","n","done","newAnimation","animationName","err","e","f","PREFIX_ANIMATE_REVERSE","isPaused","PREFIX_ANIMATE_PAUSE","goBackwards","doPause","apply","_toConsumableArray"],"sources":["../../../src/ts/actions/animate.ts"],"sourcesContent":["/**\n * @module Actions\n */\n\nimport * as MC from \"@lisn/globals/minification-constants\";\nimport * as MH from \"@lisn/globals/minification-helpers\";\n\nimport {\n  iterateAnimations,\n  resetCssAnimationsNow,\n} from \"@lisn/utils/animations\";\nimport {\n  hasClass,\n  addClassesNow,\n  removeClasses,\n  removeClassesNow,\n} from \"@lisn/utils/css-alter\";\nimport { isPageReady, waitForPageReady } from \"@lisn/utils/dom-events\";\nimport { formatAsString } from \"@lisn/utils/text\";\n\nimport { Action, registerAction } from \"@lisn/actions/action\";\n\nimport debug from \"@lisn/debug/debug\";\nimport { LoggerInterface } from \"@lisn/debug/types\";\n\n/**\n * Plays or reverses all animations on the given element.\n *\n * It works with CSS or Web Animations.\n *\n * **IMPORTANT:** When constructed, it resets and pauses the animations as a\n * form of initialization.\n *\n * -------\n *\n * To use with auto-widgets (HTML API) as part of a trigger specification:\n * - Action name: \"animate\".\n * - Accepted string arguments: none\n * - Accepted options: none\n *\n * @example\n * ```html\n * <div data-lisn-on-view=\"@animate\"></div>\n * ```\n *\n * @category Animation\n */\nexport class Animate implements Action {\n  /**\n   * (Re)plays the animations forwards.\n   */\n  readonly do: () => Promise<void>;\n\n  /**\n   * (Re)plays the animations backwards.\n   */\n  readonly undo: () => Promise<void>;\n\n  /**\n   * Reverses the animations from its current direction.\n   */\n  readonly toggle: () => Promise<void>;\n\n  static register() {\n    registerAction(\"animate\", (element) => new Animate(element));\n  }\n\n  constructor(element: Element) {\n    const logger = debug\n      ? new debug.Logger({\n          name: `Animate-${formatAsString(element)}`,\n        })\n      : null;\n\n    // initial state is 0% and paused\n    animate(element, GO_FORWARD, logger, true);\n    let isFirst = true;\n\n    this.do = () => animate(element, GO_FORWARD, logger);\n    this.undo = () => animate(element, GO_BACKWARD, logger);\n    this[MC.S_TOGGLE] = () => {\n      const res = animate(element, isFirst ? GO_FORWARD : GO_TOGGLE, logger);\n      isFirst = false;\n      return res;\n    };\n  }\n}\n\n// --------------------\n\ntype AnimateDirection =\n  | typeof GO_FORWARD\n  | typeof GO_BACKWARD\n  | typeof GO_TOGGLE;\n\nconst GO_FORWARD = 0;\nconst GO_BACKWARD = 1;\nconst GO_TOGGLE = 2;\n\nconst animate = (\n  element: Element,\n  direction: AnimateDirection,\n  logger: LoggerInterface | null,\n  isInitial = false,\n) => {\n  debug: logger?.debug8(\"Animating element\");\n  return iterateAnimations(\n    element,\n    /* istanbul ignore next */ // jsdom doesn't support Web Animations\n    (animation) => setupAnimation(animation, direction, logger, isInitial),\n    (element) => setupAnimationLegacy(element, direction, logger, isInitial),\n    isInitial,\n  );\n};\n\n/* istanbul ignore next */ // jsdom doesn't support Web Animations\nconst setupAnimation = (\n  animation: Animation,\n  direction: AnimateDirection,\n  logger: LoggerInterface | null,\n  isInitial: boolean,\n) => {\n  const pauseTillReady = !isPageReady();\n  const isBackward = animation.playbackRate === -1;\n\n  debug: logger?.debug9(\"Setting up animation\", animation, {\n    direction,\n    isBackward,\n  });\n\n  if (\n    direction === GO_TOGGLE ||\n    (direction === GO_FORWARD && isBackward) ||\n    (direction === GO_BACKWARD && !isBackward)\n  ) {\n    debug: logger?.debug9(\"Reversing animation\", animation.playState);\n    animation.reverse();\n  } else if (animation.playState === \"paused\") {\n    debug: logger?.debug9(\"Playing animation\", animation.playState);\n    animation.play();\n  } else {\n    debug: logger?.debug9(\n      \"Animation has played or is playing already\",\n      animation.playState,\n    );\n  }\n\n  if (isInitial || pauseTillReady) {\n    debug: logger?.debug9(\"Pausing animation\", animation.playState);\n    animation.pause();\n\n    if (!isInitial) {\n      // we were only pausing until ready\n      /* istanbul ignore next */\n      waitForPageReady().then(() => {\n        debug: logger?.debug9(\"Restarting animation\", animation.playState);\n        animation.play();\n      });\n    }\n  }\n\n  // If the element is moved (including if wrapped, such as by the ViewTrigger),\n  // this will cancel CSS animations and replace them with new running ones\n  if (MH.isInstanceOf(animation, CSSAnimation)) {\n    const cancelHandler = (event: AnimationPlaybackEvent) =>\n      onAnimationCancel(event, animation, direction, logger, isInitial);\n\n    animation.addEventListener(MC.S_CANCEL, cancelHandler);\n    animation.addEventListener(\"finish\", () =>\n      animation.removeEventListener(MC.S_CANCEL, cancelHandler),\n    );\n  }\n};\n\n/* istanbul ignore next */ // jsdom doesn't support Web Animations\nconst onAnimationCancel = (\n  event: AnimationPlaybackEvent,\n  animation: CSSAnimation,\n  direction: AnimateDirection,\n  logger: LoggerInterface | null,\n  isInitial: boolean,\n) => {\n  // setup again the new animation\n  debug: logger?.debug9(\"Animation cancelled, re-setting up new one\");\n  const target = MH.targetOf(event);\n  if (!MH.isInstanceOf(target, Animation)) {\n    return;\n  }\n\n  const effect = target.effect;\n  if (!MH.isInstanceOf(effect, KeyframeEffect)) {\n    return;\n  }\n\n  for (const newAnimation of MH.targetOf(effect)?.getAnimations() || []) {\n    if (\n      MH.isInstanceOf(newAnimation, CSSAnimation) &&\n      newAnimation.animationName === animation.animationName\n    ) {\n      setupAnimation(newAnimation, direction, logger, isInitial);\n      break;\n    }\n  }\n};\n\nconst setupAnimationLegacy = (\n  element: Element,\n  direction: AnimateDirection,\n  logger: LoggerInterface | null,\n  isInitial: boolean,\n) => {\n  const isBackward = hasClass(element, MC.PREFIX_ANIMATE_REVERSE);\n  const isPaused = hasClass(element, MC.PREFIX_ANIMATE_PAUSE);\n\n  const pauseTillReady = !isPageReady();\n\n  const goBackwards =\n    direction === GO_BACKWARD || (direction === GO_TOGGLE && !isBackward);\n\n  const doPause = isInitial || pauseTillReady;\n\n  debug: logger?.debug9(\"Setting up legacy animations\", element, {\n    direction,\n    isBackward,\n    isPaused,\n    goBackwards,\n    doPause,\n  });\n\n  if (goBackwards === isBackward && doPause === isPaused) {\n    // nothing to do\n    debug: logger?.debug9(\"No need to reset or pause animation\");\n    return;\n  }\n\n  resetCssAnimationsNow(element);\n\n  removeClassesNow(element, MC.PREFIX_ANIMATE_PAUSE, MC.PREFIX_ANIMATE_REVERSE);\n  addClassesNow(\n    element,\n    ...(goBackwards ? [MC.PREFIX_ANIMATE_REVERSE] : []),\n    ...(doPause ? [MC.PREFIX_ANIMATE_PAUSE] : []),\n  );\n\n  if (!isInitial && pauseTillReady) {\n    waitForPageReady().then(() =>\n      removeClasses(element, MC.PREFIX_ANIMATE_PAUSE),\n    );\n  }\n};\n"],"mappings":"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","ignoreList":[]}