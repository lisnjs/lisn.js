{"version":3,"file":"event.js","names":["MC","MH","addClasses","removeClasses","copyExistingKeys","newXMapGetter","newXWeakMap","callEventListener","handler","event","isFunction","call","currentTarget","self","handleEvent","addEventListenerTo","target","eventType","options","transformEventType","getEventHandlerData","thirdArg","wrappedHandler","supports","getBrowserSupport","isNonPrimitive","_optionsArg","_options$capture","capture","once","_options","removeEventListenerFrom","setEventHandlerData","_wrappedHandler","_thirdArg","addEventListener","data","removeEventListener","deleteEventHandlerData","preventSelect","S_SELECTSTART","preventDefault","isElement","PREFIX_NO_SELECT","undoPreventSelect","browserEventSupport","_pointer","passive","signal","optTest","opt","thisOpt","defineProperty","get","AbortController","dummyHandler","dummyElement","createElement","e__ignored","registeredEventHandlerData","newMap","getEventOptionsStr","finalOptions","isObject","stringify","_registeredEventHandl","optionsStr","_registeredEventHandl2","deleteKey","prune","sGet","set","startsWith","S_POINTER","strReplace","S_MOUSE"],"sources":["../../../src/ts/utils/event.ts"],"sourcesContent":["/**\n * @module Utils\n */\n\nimport * as MC from \"@lisn/globals/minification-constants\";\nimport * as MH from \"@lisn/globals/minification-helpers\";\n\nimport { addClasses, removeClasses } from \"@lisn/utils/css-alter\";\nimport { copyExistingKeys } from \"@lisn/utils/misc\";\n\nimport { XMap, newXMapGetter, newXWeakMap } from \"@lisn/modules/x-map\";\n\n/**\n * Calls the given event listener, which could be a function that's callable\n * directly, or an object that has a `handleEvent` function property.\n *\n * @category Events: Generic\n */\nexport const callEventListener = (\n  handler: EventListenerOrEventListenerObject,\n  event: Event,\n) => {\n  if (MH.isFunction(handler)) {\n    handler.call(event.currentTarget || self, event);\n  } else {\n    handler.handleEvent.call(event.currentTarget || self, event);\n  }\n};\n\n/**\n * Adds an event listener for the given event name to the given target.\n *\n * Like {@link https://developer.mozilla.org/en-US/docs/Web/API/EventTarget/addEventListener | EventTarget:addEventListener}\n * but it handles `options` object in case the browser does not support those.\n * Does not support the `signal` option unless browser natively supports that.\n *\n * @returns {} `true` if successfully added, or `false` if the same handler has\n * already been added by us, or if the handler is not a valid event listener.\n *\n * @category Events: Generic\n */\nexport const addEventListenerTo = (\n  target: EventTarget,\n  eventType: string,\n  handler: EventListenerOrEventListenerObject,\n  options: boolean | AddEventListenerOptions = {},\n): boolean => {\n  eventType = transformEventType(eventType);\n  if (getEventHandlerData(target, eventType, handler, options)) {\n    // already added\n    return false;\n  }\n\n  let thirdArg = options;\n  let wrappedHandler = handler;\n\n  // If the user passed an options object but the browser only supports a\n  // boolen for 'useCapture', then handle this.\n  const supports = getBrowserSupport();\n  if (MH.isNonPrimitive(options)) {\n    if (!supports._optionsArg) {\n      thirdArg = options.capture ?? false;\n    }\n\n    if (options.once && !supports._options.once) {\n      // Remove the handler once it's called once\n      wrappedHandler = (event) => {\n        removeEventListenerFrom(target, eventType, handler, options);\n        callEventListener(handler, event);\n      };\n    }\n  }\n\n  setEventHandlerData(target, eventType, handler, options, {\n    _wrappedHandler: wrappedHandler,\n    _thirdArg: thirdArg,\n  });\n\n  target.addEventListener(eventType, wrappedHandler, thirdArg);\n  return true;\n};\n\n/**\n * Removes an event listener that has been added using\n * {@link addEventListenerTo}.\n *\n * **IMPORTANT:** If you have added a listener using the built-in\n * {@link https://developer.mozilla.org/en-US/docs/Web/API/EventTarget/addEventListener | EventTarget:addEventListener},\n * then you should use\n * {@link https://developer.mozilla.org/en-US/docs/Web/API/EventTarget/removeEventListener | EventTarget:removeEventListener},\n * to remove it, not this function.\n *\n * @returns {} `true` if successfully removed, or `false` if the handler has not\n * been added by us.\n *\n * @category Events: Generic\n */\nexport const removeEventListenerFrom = (\n  target: EventTarget,\n  eventType: string,\n  handler: EventListenerOrEventListenerObject,\n  options: boolean | AddEventListenerOptions = {},\n) => {\n  eventType = transformEventType(eventType);\n  const data = getEventHandlerData(target, eventType, handler, options);\n\n  if (!data) {\n    return false;\n  }\n\n  target.removeEventListener(eventType, data._wrappedHandler, data._thirdArg);\n  deleteEventHandlerData(target, eventType, handler, options);\n  return true;\n};\n\n/**\n * @ignore\n * @internal\n */\nexport const preventSelect = (target: EventTarget) => {\n  addEventListenerTo(target, MC.S_SELECTSTART, MH.preventDefault);\n  if (MH.isElement(target)) {\n    addClasses(target, MC.PREFIX_NO_SELECT);\n  }\n};\n\n/**\n * @ignore\n * @internal\n */\nexport const undoPreventSelect = (target: EventTarget) => {\n  removeEventListenerFrom(target, MC.S_SELECTSTART, MH.preventDefault);\n  if (MH.isElement(target)) {\n    removeClasses(target, MC.PREFIX_NO_SELECT);\n  }\n};\n\n/**\n * @ignore\n * @internal\n */\nexport const getBrowserSupport = (): BrowserEventSupport => {\n  if (browserEventSupport) {\n    // already detected\n    return browserEventSupport;\n  }\n\n  const supports = {\n    _pointer: false,\n    _optionsArg: false,\n    _options: {\n      capture: false,\n      passive: false,\n      once: false,\n      signal: false,\n    },\n  };\n\n  // https://developer.mozilla.org/en-US/docs/Web/API/EventTarget/addEventListener#safely_detecting_option_support\n  const optTest = {};\n  let opt: keyof typeof supports._options;\n  for (opt in supports._options) {\n    const thisOpt = opt;\n    MH.defineProperty(optTest, thisOpt, {\n      get: () => {\n        supports._options[thisOpt] = true;\n        if (thisOpt === \"signal\") {\n          return new AbortController().signal;\n        }\n        return false;\n      },\n    });\n  }\n\n  const dummyHandler = () => {}; // TypeScript does not accept null\n  const dummyElement = MH.createElement(\"div\");\n  try {\n    dummyElement.addEventListener(\"testOptionSupport\", dummyHandler, optTest);\n    dummyElement.removeEventListener(\n      \"testOptionSupport\",\n      dummyHandler,\n      optTest,\n    );\n    supports._optionsArg = true;\n  } catch (e__ignored) {\n    //\n  }\n\n  supports._pointer = \"onpointerup\" in dummyElement;\n\n  browserEventSupport = supports;\n  return supports;\n};\n\n// --------------------\n\ntype EventHandlerData = {\n  _wrappedHandler: EventListenerOrEventListenerObject;\n  _thirdArg: boolean | AddEventListenerOptions;\n};\n\nlet browserEventSupport: BrowserEventSupport;\n\nconst registeredEventHandlerData = newXWeakMap<\n  EventTarget,\n  XMap<\n    string, // event type\n    XMap<\n      EventListenerOrEventListenerObject, // user-supplied handler\n      Map<\n        string, // str repr of options\n        EventHandlerData\n      >\n    >\n  >\n>(newXMapGetter(newXMapGetter(() => MH.newMap())));\n\n// detect browser features, see below\ntype BrowserEventSupport = {\n  _pointer: boolean;\n  _optionsArg: boolean;\n  _options: {\n    capture: boolean;\n    passive: boolean;\n    once: boolean;\n    signal: boolean;\n  };\n};\n\nconst getEventOptionsStr = (\n  options: boolean | AddEventListenerOptions,\n): string => {\n  const finalOptions: AddEventListenerOptions = {\n    capture: false,\n    passive: false,\n    once: false,\n  };\n\n  if (options === false || options === true) {\n    finalOptions.capture = options;\n  } else if (MH.isObject(options)) {\n    copyExistingKeys(options, finalOptions);\n  }\n\n  return MH.stringify(finalOptions);\n};\n\nconst getEventHandlerData = (\n  target: EventTarget,\n  eventType: string,\n  handler: EventListenerOrEventListenerObject,\n  options: boolean | AddEventListenerOptions,\n) => {\n  const optionsStr = getEventOptionsStr(options);\n  return registeredEventHandlerData\n    .get(target)\n    ?.get(eventType)\n    ?.get(handler)\n    ?.get(optionsStr);\n};\n\nconst deleteEventHandlerData = (\n  target: EventTarget,\n  eventType: string,\n  handler: EventListenerOrEventListenerObject,\n  options: boolean | AddEventListenerOptions,\n) => {\n  const optionsStr = getEventOptionsStr(options);\n  MH.deleteKey(\n    registeredEventHandlerData.get(target)?.get(eventType)?.get(handler),\n    optionsStr,\n  );\n  registeredEventHandlerData.prune(target, eventType, handler);\n};\n\nconst setEventHandlerData = (\n  target: EventTarget,\n  eventType: string,\n  handler: EventListenerOrEventListenerObject,\n  options: boolean | AddEventListenerOptions,\n  data: EventHandlerData,\n) => {\n  const optionsStr = getEventOptionsStr(options);\n  registeredEventHandlerData\n    .sGet(target)\n    .sGet(eventType)\n    .sGet(handler)\n    .set(optionsStr, data);\n};\n\nconst transformEventType = (eventType: string) => {\n  const supports = getBrowserSupport();\n  if (eventType.startsWith(MC.S_POINTER) && !supports._pointer) {\n    // TODO maybe log a warning message is it's not supported, e.g. there's no\n    // mousecancel\n    return MH.strReplace(eventType, MC.S_POINTER, MC.S_MOUSE);\n  }\n\n  return eventType;\n};\n"],"mappings":"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","ignoreList":[]}