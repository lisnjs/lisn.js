{"version":3,"file":"x-intersection-observer.js","names":["MH","XIntersectionObserver","constructor","callback","observeOptions","_defineProperty","observedTargets","newWeakSet","targetsToSkip","intersectionHandler","entries","selectedEntries","entry","has","targetOf","deleteKey","push","lengthOf","observer","newIntersectionObserver","defineProperty","get","root","rootMargin","thresholds","observe","targets","target","add","observeLater","unobserve","disconnect","takeRecords"],"sources":["../../../src/ts/modules/x-intersection-observer.ts"],"sourcesContent":["/**\n * @module Modules/XIntersectionObserver\n */\n\nimport * as MH from \"@lisn/globals/minification-helpers\";\n\nexport type XIntersectionObserverCallback = (\n  entries: IntersectionObserverEntry[],\n  observer: XIntersectionObserver,\n) => void;\n\n/**\n * {@link XIntersectionObserver} is an extension of\n * {@link https://developer.mozilla.org/en-US/docs/Web/API/IntersectionObserver | IntersectionObserver}\n * with added capabilities:\n * - can skip the initial callback that happens shortly after setting up via\n *   {@link observeLater}\n */\nexport class XIntersectionObserver {\n  /**\n   * Like {@link https://developer.mozilla.org/en-US/docs/Web/API/IntersectionObserver/root | IntersectionObserver:root}.\n   */\n  readonly root!: Element | Document | null;\n\n  /**\n   * Like {@link https://developer.mozilla.org/en-US/docs/Web/API/IntersectionObserver/rootMargin | IntersectionObserver:rootMargin}.\n   */\n  readonly rootMargin!: string;\n\n  /**\n   * Like {@link https://developer.mozilla.org/en-US/docs/Web/API/IntersectionObserver/thresholds | IntersectionObserver:thresholds}.\n   */\n  readonly thresholds!: number[];\n\n  /**\n   * Like {@link https://developer.mozilla.org/en-US/docs/Web/API/IntersectionObserver/observe | IntersectionObserver:observe} except it accepts multiple\n   * targets.\n   */\n  readonly observe: (...targets: Element[]) => void;\n\n  /**\n   * Like {@link observe} but it ignores the initial almost immediate callback\n   * and only calls the callback on a subsequent intersection change.\n   */\n  readonly observeLater: (...targets: Element[]) => void;\n\n  /**\n   * Like {@link https://developer.mozilla.org/en-US/docs/Web/API/IntersectionObserver/unobserve | IntersectionObserver:unobserve} except it accepts multiple\n   * targets.\n   */\n  readonly unobserve: (...targets: Element[]) => void;\n\n  /**\n   * Like {@link https://developer.mozilla.org/en-US/docs/Web/API/IntersectionObserver/disconnect | IntersectionObserver:disconnect}.\n   */\n  readonly disconnect: () => void;\n\n  /**\n   * Like `IntersectionObserver.takeRecords`.\n   */\n  readonly takeRecords: () => void;\n\n  constructor(\n    callback: XIntersectionObserverCallback,\n    observeOptions?: IntersectionObserverInit,\n  ) {\n    let observedTargets = MH.newWeakSet<Element>();\n    const targetsToSkip = MH.newWeakSet<Element>();\n\n    const intersectionHandler = (entries: IntersectionObserverEntry[]) => {\n      const selectedEntries = [];\n\n      for (const entry of entries) {\n        if (targetsToSkip.has(MH.targetOf(entry))) {\n          MH.deleteKey(targetsToSkip, MH.targetOf(entry));\n          continue;\n        }\n\n        selectedEntries.push(entry);\n      }\n\n      if (MH.lengthOf(selectedEntries)) {\n        callback(selectedEntries, this);\n      }\n    };\n\n    const observer = MH.newIntersectionObserver(\n      intersectionHandler,\n      observeOptions,\n    );\n\n    MH.defineProperty(this, \"root\", { get: () => observer.root });\n    MH.defineProperty(this, \"rootMargin\", {\n      get: () => observer.rootMargin,\n    });\n    MH.defineProperty(this, \"thresholds\", {\n      get: () => observer.thresholds,\n    });\n\n    this.observe = (...targets) => {\n      for (const target of targets) {\n        observedTargets.add(target);\n        observer.observe(target);\n      }\n    };\n\n    this.observeLater = (...targets) => {\n      for (const target of targets) {\n        // Only skip them if not already observed, otherwise the initial\n        // (almost) immediate callback won't happen anyway.\n        if (observedTargets.has(target)) {\n          continue;\n        }\n\n        targetsToSkip.add(target);\n        this.observe(target);\n      }\n    };\n\n    this.unobserve = (...targets) => {\n      for (const target of targets) {\n        MH.deleteKey(observedTargets, target);\n        observer.unobserve(target);\n      }\n    };\n\n    this.disconnect = () => {\n      observedTargets = MH.newWeakSet();\n      observer.disconnect();\n    };\n\n    this.takeRecords = () => observer.takeRecords();\n  }\n}\n"],"mappings":"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","ignoreList":[]}