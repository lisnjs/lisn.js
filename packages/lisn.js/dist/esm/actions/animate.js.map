{"version":3,"file":"animate.js","names":["MC","MH","iterateAnimations","resetCssAnimationsNow","hasClass","addClassesNow","removeClasses","removeClassesNow","isPageReady","waitForPageReady","formatAsString","registerAction","debug","Animate","register","element","constructor","_defineProperty","logger","Logger","name","animate","GO_FORWARD","isFirst","do","undo","GO_BACKWARD","S_TOGGLE","res","GO_TOGGLE","direction","isInitial","debug8","animation","setupAnimation","setupAnimationLegacy","pauseTillReady","isBackward","playbackRate","debug9","playState","reverse","play","pause","then","isInstanceOf","CSSAnimation","cancelHandler","event","onAnimationCancel","addEventListener","S_CANCEL","removeEventListener","target","targetOf","Animation","effect","KeyframeEffect","newAnimation","_MH$targetOf","getAnimations","animationName","PREFIX_ANIMATE_REVERSE","isPaused","PREFIX_ANIMATE_PAUSE","goBackwards","doPause"],"sources":["../../../src/ts/actions/animate.ts"],"sourcesContent":["/**\n * @module Actions\n */\n\nimport * as MC from \"@lisn/globals/minification-constants\";\nimport * as MH from \"@lisn/globals/minification-helpers\";\n\nimport {\n  iterateAnimations,\n  resetCssAnimationsNow,\n} from \"@lisn/utils/animations\";\nimport {\n  hasClass,\n  addClassesNow,\n  removeClasses,\n  removeClassesNow,\n} from \"@lisn/utils/css-alter\";\nimport { isPageReady, waitForPageReady } from \"@lisn/utils/dom-events\";\nimport { formatAsString } from \"@lisn/utils/text\";\n\nimport { Action, registerAction } from \"@lisn/actions/action\";\n\nimport debug from \"@lisn/debug/debug\";\nimport { LoggerInterface } from \"@lisn/debug/types\";\n\n/**\n * Plays or reverses all animations on the given element.\n *\n * It works with CSS or Web Animations.\n *\n * **IMPORTANT:** When constructed, it resets and pauses the animations as a\n * form of initialization.\n *\n * -------\n *\n * To use with auto-widgets (HTML API) as part of a trigger specification:\n * - Action name: \"animate\".\n * - Accepted string arguments: none\n * - Accepted options: none\n *\n * @example\n * ```html\n * <div data-lisn-on-view=\"@animate\"></div>\n * ```\n *\n * @category Animation\n */\nexport class Animate implements Action {\n  /**\n   * (Re)plays the animations forwards.\n   */\n  readonly do: () => Promise<void>;\n\n  /**\n   * (Re)plays the animations backwards.\n   */\n  readonly undo: () => Promise<void>;\n\n  /**\n   * Reverses the animations from its current direction.\n   */\n  readonly toggle: () => Promise<void>;\n\n  static register() {\n    registerAction(\"animate\", (element) => new Animate(element));\n  }\n\n  constructor(element: Element) {\n    const logger = debug\n      ? new debug.Logger({\n          name: `Animate-${formatAsString(element)}`,\n        })\n      : null;\n\n    // initial state is 0% and paused\n    animate(element, GO_FORWARD, logger, true);\n    let isFirst = true;\n\n    this.do = () => animate(element, GO_FORWARD, logger);\n    this.undo = () => animate(element, GO_BACKWARD, logger);\n    this[MC.S_TOGGLE] = () => {\n      const res = animate(element, isFirst ? GO_FORWARD : GO_TOGGLE, logger);\n      isFirst = false;\n      return res;\n    };\n  }\n}\n\n// --------------------\n\ntype AnimateDirection =\n  | typeof GO_FORWARD\n  | typeof GO_BACKWARD\n  | typeof GO_TOGGLE;\n\nconst GO_FORWARD = 0;\nconst GO_BACKWARD = 1;\nconst GO_TOGGLE = 2;\n\nconst animate = (\n  element: Element,\n  direction: AnimateDirection,\n  logger: LoggerInterface | null,\n  isInitial = false,\n) => {\n  debug: logger?.debug8(\"Animating element\");\n  return iterateAnimations(\n    element,\n    /* istanbul ignore next */ // jsdom doesn't support Web Animations\n    (animation) => setupAnimation(animation, direction, logger, isInitial),\n    (element) => setupAnimationLegacy(element, direction, logger, isInitial),\n    isInitial,\n  );\n};\n\n/* istanbul ignore next */ // jsdom doesn't support Web Animations\nconst setupAnimation = (\n  animation: Animation,\n  direction: AnimateDirection,\n  logger: LoggerInterface | null,\n  isInitial: boolean,\n) => {\n  const pauseTillReady = !isPageReady();\n  const isBackward = animation.playbackRate === -1;\n\n  debug: logger?.debug9(\"Setting up animation\", animation, {\n    direction,\n    isBackward,\n  });\n\n  if (\n    direction === GO_TOGGLE ||\n    (direction === GO_FORWARD && isBackward) ||\n    (direction === GO_BACKWARD && !isBackward)\n  ) {\n    debug: logger?.debug9(\"Reversing animation\", animation.playState);\n    animation.reverse();\n  } else if (animation.playState === \"paused\") {\n    debug: logger?.debug9(\"Playing animation\", animation.playState);\n    animation.play();\n  } else {\n    debug: logger?.debug9(\n      \"Animation has played or is playing already\",\n      animation.playState,\n    );\n  }\n\n  if (isInitial || pauseTillReady) {\n    debug: logger?.debug9(\"Pausing animation\", animation.playState);\n    animation.pause();\n\n    if (!isInitial) {\n      // we were only pausing until ready\n      /* istanbul ignore next */\n      waitForPageReady().then(() => {\n        debug: logger?.debug9(\"Restarting animation\", animation.playState);\n        animation.play();\n      });\n    }\n  }\n\n  // If the element is moved (including if wrapped, such as by the ViewTrigger),\n  // this will cancel CSS animations and replace them with new running ones\n  if (MH.isInstanceOf(animation, CSSAnimation)) {\n    const cancelHandler = (event: AnimationPlaybackEvent) =>\n      onAnimationCancel(event, animation, direction, logger, isInitial);\n\n    animation.addEventListener(MC.S_CANCEL, cancelHandler);\n    animation.addEventListener(\"finish\", () =>\n      animation.removeEventListener(MC.S_CANCEL, cancelHandler),\n    );\n  }\n};\n\n/* istanbul ignore next */ // jsdom doesn't support Web Animations\nconst onAnimationCancel = (\n  event: AnimationPlaybackEvent,\n  animation: CSSAnimation,\n  direction: AnimateDirection,\n  logger: LoggerInterface | null,\n  isInitial: boolean,\n) => {\n  // setup again the new animation\n  debug: logger?.debug9(\"Animation cancelled, re-setting up new one\");\n  const target = MH.targetOf(event);\n  if (!MH.isInstanceOf(target, Animation)) {\n    return;\n  }\n\n  const effect = target.effect;\n  if (!MH.isInstanceOf(effect, KeyframeEffect)) {\n    return;\n  }\n\n  for (const newAnimation of MH.targetOf(effect)?.getAnimations() || []) {\n    if (\n      MH.isInstanceOf(newAnimation, CSSAnimation) &&\n      newAnimation.animationName === animation.animationName\n    ) {\n      setupAnimation(newAnimation, direction, logger, isInitial);\n      break;\n    }\n  }\n};\n\nconst setupAnimationLegacy = (\n  element: Element,\n  direction: AnimateDirection,\n  logger: LoggerInterface | null,\n  isInitial: boolean,\n) => {\n  const isBackward = hasClass(element, MC.PREFIX_ANIMATE_REVERSE);\n  const isPaused = hasClass(element, MC.PREFIX_ANIMATE_PAUSE);\n\n  const pauseTillReady = !isPageReady();\n\n  const goBackwards =\n    direction === GO_BACKWARD || (direction === GO_TOGGLE && !isBackward);\n\n  const doPause = isInitial || pauseTillReady;\n\n  debug: logger?.debug9(\"Setting up legacy animations\", element, {\n    direction,\n    isBackward,\n    isPaused,\n    goBackwards,\n    doPause,\n  });\n\n  if (goBackwards === isBackward && doPause === isPaused) {\n    // nothing to do\n    debug: logger?.debug9(\"No need to reset or pause animation\");\n    return;\n  }\n\n  resetCssAnimationsNow(element);\n\n  removeClassesNow(element, MC.PREFIX_ANIMATE_PAUSE, MC.PREFIX_ANIMATE_REVERSE);\n  addClassesNow(\n    element,\n    ...(goBackwards ? [MC.PREFIX_ANIMATE_REVERSE] : []),\n    ...(doPause ? [MC.PREFIX_ANIMATE_PAUSE] : []),\n  );\n\n  if (!isInitial && pauseTillReady) {\n    waitForPageReady().then(() =>\n      removeClasses(element, MC.PREFIX_ANIMATE_PAUSE),\n    );\n  }\n};\n"],"mappings":"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","ignoreList":[]}