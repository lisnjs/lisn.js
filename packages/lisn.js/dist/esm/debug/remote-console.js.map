{"version":3,"file":"remote-console.js","names":["MH","tryImport","joinAsString","newXMap","RemoteConsole","constructor","url","connectTimeout","DEFAULT_TIMEOUT","_defineProperty","hasFailed","isClosed","tmpQueue","sendLog","level","args","push","destroy","debug","log","info","warn","error","cleanup","_instances$get","level__ignored","args__ignored","instance","instances","get","deleteKey","prune","socket","ioClient","io","disconnectTimer","setTimer","on","clearTimer","emit","disconnect","entry","shift","reuse","_instances$get2","rConsole","sGet","set","newMap"],"sources":["../../../src/ts/debug/remote-console.ts"],"sourcesContent":["/**\n * @module Debugging\n */\n\nimport * as MH from \"@lisn/globals/minification-helpers\";\n\nimport { LogFunction } from \"@lisn/globals/types\";\n\nimport { tryImport } from \"@lisn/utils/misc\";\nimport { joinAsString } from \"@lisn/utils/text\";\n\nimport { newXMap } from \"@lisn/modules/x-map\";\n\nimport { ConsoleInterface } from \"@lisn/debug/types\";\n\n/* ******************************\n * Remote console\n * *******************************/\n\n/**\n * Connects to a remote {@link https://socket.io/ | socket.io} server and logs\n * messages to it.\n *\n * In the root of the Git repository, there is a simple example server that\n * listens for these messages and logs them to the local console.\n *\n * @category Logging\n */\nexport class RemoteConsole implements ConsoleInterface {\n  /**\n   * Emits a message with ID `console.debug`.\n   */\n  readonly debug: LogFunction;\n\n  /**\n   * Emits a message with ID `console.log`.\n   */\n  readonly log: LogFunction;\n\n  /**\n   * Emits a message with ID `console.info`.\n   */\n  readonly info: LogFunction;\n\n  /**\n   * Emits a message with ID `console.warn`.\n   */\n  readonly warn: LogFunction;\n\n  /**\n   * Emits a message with ID `console.error`.\n   */\n  readonly error: LogFunction;\n\n  /**\n   * Disconnects and destroys the {@link RemoteConsole}. Cannot be undone.\n   */\n  readonly destroy: () => void;\n\n  /**\n   * Returns true if the client has been disconnected for more than\n   * the connect timeout.\n   */\n  readonly hasFailed: () => boolean;\n\n  /**\n   * Creates a new {@link RemoteConsole} and attempts to connect to the logger\n   * at the given URL.\n   *\n   * @param {} url                      The URL of the remote logger.\n   * @param {} [connectTimeout = 1500]  The timeout in ms for a connection\n   *                                    to be considered failed.\n   */\n  constructor(url: string, connectTimeout = DEFAULT_TIMEOUT) {\n    let hasFailed = false; // initially\n    let isClosed = false;\n\n    // Because socket.io module is optional we need to import it dynamically,\n    // which is always async. So to avoid Console and Logger also needing to be\n    // async, we queue messages sent to a RemoteConsole here and try to import\n    // socket.io here.\n    let tmpQueue: Array<[string, unknown[]]> = [];\n    let sendLog = (level: string, args: unknown[]) => {\n      tmpQueue.push([level, args]);\n    };\n    let destroy = () => {};\n\n    this.hasFailed = () => hasFailed;\n    this.debug = (...args) => sendLog(\"debug\", args);\n    this.log = (...args) => sendLog(\"log\", args);\n    this.info = (...args) => sendLog(\"info\", args);\n    this.warn = (...args) => sendLog(\"warn\", args);\n    this.error = (...args) => sendLog(\"error\", args);\n    this.destroy = () => destroy();\n\n    const cleanup = () => {\n      hasFailed = true;\n      sendLog = (level__ignored: string, args__ignored: unknown[]) => {};\n      tmpQueue = [];\n\n      const instance = instances.get(url)?.get(connectTimeout);\n      if (instance === this) {\n        MH.deleteKey(instances.get(url), connectTimeout);\n        instances.prune(url);\n      }\n    };\n\n    (async () => {\n      const socket =\n        await tryImport<typeof import(\"socket.io-client\")>(\"socket.io-client\");\n      if (!socket) {\n        // module doesn't exist\n        cleanup();\n        return;\n      }\n\n      const ioClient = socket.io(url);\n\n      // if not connected within connectTimeout initially, set as failed\n      let disconnectTimer = MH.setTimer(() => {\n        hasFailed = true;\n      }, connectTimeout);\n\n      ioClient.on(\"disconnect\", () => {\n        // if not re-connected within connectTimeout, set as failed\n        MH.clearTimer(disconnectTimer);\n        if (!isClosed) {\n          disconnectTimer = MH.setTimer(() => {\n            hasFailed = true;\n          }, connectTimeout);\n        }\n      });\n\n      ioClient.on(\"connect\", () => {\n        MH.clearTimer(disconnectTimer);\n        hasFailed = false;\n      });\n\n      // Now we can send directly to the client\n      sendLog = (level: string, args: unknown[]) => {\n        if (!hasFailed) {\n          ioClient.emit(`console.${level}`, joinAsString(\" \", ...args));\n        }\n      };\n\n      destroy = () => {\n        isClosed = true; // do not wait for re-connect\n        ioClient.disconnect();\n        cleanup();\n      };\n\n      // Flush the queue\n      let entry: [string, unknown[]] | undefined;\n      while ((entry = tmpQueue.shift())) {\n        sendLog(entry[0], entry[1]);\n      }\n    })();\n  }\n\n  /**\n   * Returns an existing {@link RemoteConsole} for the given URL and timeout or\n   * creates a new one.\n   *\n   * If a new one is created, it will be saved for later reuse.\n   *\n   * @param {} url               The URL of the remote logger.\n   * @param {} [connectTimeout]  The timeout in ms for a remote connection to\n   *                             be considered failed. Default is 1500.\n   */\n  static reuse(url: string, connectTimeout = DEFAULT_TIMEOUT) {\n    let rConsole = instances.get(url)?.get(connectTimeout);\n    if (!rConsole) {\n      rConsole = new RemoteConsole(url, connectTimeout);\n      instances.sGet(url).set(connectTimeout, rConsole);\n    }\n\n    return rConsole;\n  }\n}\n\nconst instances = newXMap<string, Map<number, RemoteConsole>>(() =>\n  MH.newMap(),\n);\n\nconst DEFAULT_TIMEOUT = 1500;\n"],"mappings":"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","ignoreList":[]}