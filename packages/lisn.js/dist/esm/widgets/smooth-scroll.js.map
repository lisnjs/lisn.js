{"version":3,"file":"smooth-scroll.js","names":["MC","MH","newCriticallyDampedAnimationIterator","supportsSticky","addClassesNow","removeClassesNow","setBooleanDataNow","delDataNow","setNumericStyleJsVars","setNumericStyleJsVarsNow","moveElementNow","getContentWrapper","tryWrapContentNow","unwrapContentNow","waitForMeasureTime","waitForMutateTime","logError","toArrayIfSingle","isScrollable","getDefaultScrollingElement","formatAsString","validateStrList","validateNumber","validateString","ScrollWatcher","SizeWatcher","Widget","registerWidget","debug","SmoothScroll","get","scrollable","mainWidget","getDocElement","getBody","instance","DUMMY_ID","isInstanceOf","enableMain","config","fetchMainScrollableElement","widget","onDestroy","register","WIDGET_NAME","element","isHTMLElement","usageError","configValidator","constructor","_SmoothScroll$get","destroyPromise","destroy","id","promiseResolve","then","isDestroyed","init","PREFIXED_NAME","prefixName","PREFIX_ROOT","PREFIX_DUMMY","PREFIX_OUTER_WRAPPER","PREFIX_INNER_WRAPPER","PREFIX_HAS_H_SCROLL","PREFIX_HAS_V_SCROLL","PREFIX_USES_STICKY","className","lag","createWrappers","classNamesEntries","wrapContentNow","classNames","_classNames","_required","_requiredBy","lastWrapper","result","createdByUs","unwrapFn","wrapper","key","allClassNames","PREFIX_WRAPPER","push","wrappers","docEl","body","defaultScrollable","needsSticky","root","logger","Logger","name","logAtCreation","scrollWatcher","reuse","S_DEBOUNCE_WINDOW","sizeWatcher","initialContentWidth","S_SCROLL_WIDTH","initialContentHeight","S_SCROLL_HEIGHT","debug5","clientWidth","clientHeight","scrollWidth","scrollHeight","hasHScroll","axis","hasVScroll","setSizeVars","width","height","now","_units","_numDecimal","updatePropsOnScroll","target","scrollData","updateTargetPosition","innerWrapper","S_CLIENT_WIDTH","NaN","S_CLIENT_HEIGHT","updatePropsOnResize","sizeData","dummy","border","S_WIDTH","S_HEIGHT","currentPositions","x","y","targetPositions","copyObject","d","current","newTarget","S_SCROLL_LEFT","S_SCROLL_TOP","isOngoing","animateTransforms","_config$lag","debug10","iterator","l","lTarget","next","value","_prefix","console","log","JSON","stringify","addWatchers","trackScroll","threshold","onResize","removeWatchers","noTrackScroll","offResize","outerWrapper","o","i","createElement","to","ignoreMove","onDisable","onEnable"],"sources":["../../../src/ts/widgets/smooth-scroll.ts"],"sourcesContent":["/**\n * @module Widgets\n */\n\nimport * as MC from \"@lisn/globals/minification-constants\";\nimport * as MH from \"@lisn/globals/minification-helpers\";\n\nimport { newCriticallyDampedAnimationIterator } from \"@lisn/utils/animations\";\nimport { supportsSticky } from \"@lisn/utils/browser\";\nimport {\n  addClassesNow,\n  removeClassesNow,\n  setBooleanDataNow,\n  delDataNow,\n  setNumericStyleJsVars,\n  setNumericStyleJsVarsNow,\n} from \"@lisn/utils/css-alter\";\nimport {\n  moveElementNow,\n  getContentWrapper,\n  tryWrapContentNow,\n  unwrapContentNow,\n} from \"@lisn/utils/dom-alter\";\nimport {\n  waitForMeasureTime,\n  waitForMutateTime,\n} from \"@lisn/utils/dom-optimize\";\nimport { logError } from \"@lisn/utils/log\";\nimport { toArrayIfSingle } from \"@lisn/utils/misc\";\nimport { isScrollable, getDefaultScrollingElement } from \"@lisn/utils/scroll\";\nimport { formatAsString } from \"@lisn/utils/text\";\nimport {\n  validateStrList,\n  validateNumber,\n  validateString,\n} from \"@lisn/utils/validation\";\n\nimport { ScrollWatcher, ScrollData } from \"@lisn/watchers/scroll-watcher\";\nimport { SizeWatcher, SizeData } from \"@lisn/watchers/size-watcher\";\n\nimport {\n  Widget,\n  WidgetConfigValidatorObject,\n  registerWidget,\n} from \"@lisn/widgets/widget\";\n\nimport debug from \"@lisn/debug/debug\";\n\n/**\n * Configures the given element as a {@link SmoothScroll} widget.\n *\n * The SmoothScroll widget creates a configurable smooth scrolling\n * experience, including support for lag and parallax depth, and using a custom\n * element that only takes up part of the page, all while preserving native\n * scrolling behaviour (i.e. it does not disable native scroll and does not use\n * fake scrollbars).\n *\n * **IMPORTANT:** The scrollable element you pass must have its children\n * wrapped. This will be done automatically unless you create these wrappers\n * yourself by ensuring your structure is as follows:\n *\n * ```html\n * <!-- If using the document as the scrollable -->\n * <body><!-- Element you instantiate as SmoothScroll, or you can pass documentElement -->\n *   <div class=\"lisn-smooth-scroll__content\"><!-- Required wrapper; will be created if missing -->\n *     <div class=\"lisn-smooth-scroll__inner\"><!-- Required inner wrapper; will be created if missing -->\n *       <!-- YOUR CONTENT -->\n *     </div>\n *   </div>\n * </body>\n * ```\n *\n * ```html\n * <!-- If using a custom scrollable -->\n * <div class=\"scrollable\"><!-- Element you instantiate as SmoothScroll -->\n *   <div class=\"lisn-smooth-scroll__content\"><!-- Required outer wrapper; will be created if missing -->\n *     <div class=\"lisn-smooth-scroll__inner\"><!-- Required inner wrapper; will be created if missing -->\n *       <!-- YOUR CONTENT -->\n *     </div>\n *   </div>\n * </div>\n * ```\n *\n * **IMPORTANT:** If the scrollable element you pass is other than\n * `document.documentElement` or `document.body`, SmoothScroll will then rely on\n * position: sticky. XXX TODO\n *\n * **IMPORTANT:** You should not instantiate more than one\n * {@link SmoothScroll} widget on a given element. Use\n * {@link SmoothScroll.get} to get an existing instance if any. If there is\n * already a widget instance, it will be destroyed!\n *\n * -----\n *\n * To use with auto-widgets (HTML API) (see\n * {@link Settings.settings.autoWidgets | settings.autoWidgets}), the following\n * CSS classes or data attributes are recognized:\n * - `lisn-smooth-scroll` class or `data-lisn-smooth-scroll` attribute set\n *   on the container element that constitutes the scrollable container\n *\n * See below examples for what values you can use set for the data attribute\n * in order to modify the configuration of the automatically created widget.\n *\n * @example\n * This will create a smooth scroller for\n * {@link settings.mainScrollableElementSelector | the main scrolling element}.\n *\n * This will work even if {@link settings.autoWidgets}) is false\n *\n * ```html\n * <!-- LISN should be loaded beforehand -->\n * <script>\n *   // You can also just customise global default settings:\n *   // LISN.settings.smoothScroll = \"TODO\";\n *\n *   LISN.widgets.SmoothScroll.enableMain({\n *     XXX: \"TODO\",\n *   });\n * </script>\n * ```\n *\n * @example\n * This will create a smooth scroller for a custom scrolling element (i.e. one\n * with overflow \"auto\" or \"scroll\").\n *\n * ```html\n * <div class=\"scrolling lisn-smooth-scroll\">\n *   <!-- content here... -->\n * </div>\n * ```\n *\n * @example\n * As above but with custom settings.\n *\n * ```html\n * <div\n *   class=\"scrolling\"\n *   data-lisn-smooth-scroll=\"XXX=TODO\n *                            | XXX=TODO\n *                        \">\n *   <!-- content here... -->\n * </div>\n * ```\n */\nexport class SmoothScroll extends Widget {\n  // XXX TODO getScrollable ?\n\n  /**\n   * If element is omitted, returns the instance created by {@link enableMain}\n   * if any.\n   */\n  static get(scrollable?: Element): SmoothScroll | null {\n    if (!scrollable) {\n      return mainWidget;\n    }\n\n    if (scrollable === MH.getDocElement()) {\n      scrollable = MH.getBody();\n    }\n\n    const instance = super.get(scrollable, DUMMY_ID);\n    if (MH.isInstanceOf(instance, SmoothScroll)) {\n      return instance;\n    }\n    return null;\n  }\n\n  /**\n   * Creates a smooth scroller for the\n   * {@link settings.mainScrollableElementSelector | the main scrolling element}.\n   *\n   * **NOTE:** It returns a Promise to a widget because it will wait for the\n   * main scrollable element to be present in the DOM if not already.\n   */\n  static async enableMain(config?: SmoothScrollConfig) {\n    const scrollable = await ScrollWatcher.fetchMainScrollableElement();\n    const widget = new SmoothScroll(scrollable, config);\n    widget.onDestroy(() => {\n      if (mainWidget === widget) {\n        mainWidget = null;\n      }\n    });\n\n    mainWidget = widget;\n    return widget;\n  }\n\n  static register() {\n    registerWidget(\n      WIDGET_NAME,\n      (element, config) => {\n        if (MH.isHTMLElement(element)) {\n          if (!SmoothScroll.get(element)) {\n            return new SmoothScroll(element, config);\n          }\n        } else {\n          logError(\n            MH.usageError(\n              \"Only HTMLElement is supported for SmoothScroll widget\",\n            ),\n          );\n        }\n        return null;\n      },\n      configValidator,\n    );\n  }\n\n  /**\n   * Note that passing `document.body` is considered equivalent to\n   * `document.documentElement`.\n   */\n  constructor(scrollable: HTMLElement, config?: SmoothScrollConfig) {\n    if (scrollable === MH.getDocElement()) {\n      scrollable = MH.getBody();\n    }\n\n    const destroyPromise = SmoothScroll.get(scrollable)?.destroy();\n    super(scrollable, { id: DUMMY_ID });\n\n    // const props = getScrollableProps(scrollable); // XXX\n    // const ourScrollable = props.scrollable; // XXX\n\n    (destroyPromise || MH.promiseResolve()).then(async () => {\n      if (this.isDestroyed()) {\n        return;\n      }\n\n      init(this, scrollable, config);\n      // XXX init(this, scrollable, props, config);\n    });\n  }\n}\n\n/**\n * @interface\n */\nexport type SmoothScrollConfig = {\n  /**\n   * The DOM ID to set on the outer content wrapper. Will result in the content\n   * wrapper element that's created by us getting this ID.\n   *\n   * @defaultValue undefined\n   */\n  id?: string;\n\n  /**\n   * A class name or a list of class names to set on the outer content wrapper.\n   * Will result in the content wrapper element that's created by us getting\n   * these classes.\n   *\n   * @defaultValue undefined\n   */\n  className?: string[] | string;\n\n  /**\n   * XXX TODO\n   *\n   * @defaultValue {@link settings.smoothScrollLag}\n   */\n  lag?: number;\n\n  /**\n   * XXX TODO\n   *\n   * @defaultValue {@link settings.smoothScrollDepth}\n   */\n  depth?: number;\n};\n\n// --------------------\n\nconst WIDGET_NAME = \"smooth-scroll\";\nconst PREFIXED_NAME = MH.prefixName(WIDGET_NAME);\n// Only one SmoothScroll widget per element is allowed, but Widget requires a\n// non-blank ID.\nconst DUMMY_ID = PREFIXED_NAME;\nconst PREFIX_ROOT = `${PREFIXED_NAME}__root`;\nconst PREFIX_DUMMY = `${PREFIXED_NAME}__dummy`;\nconst PREFIX_OUTER_WRAPPER = `${PREFIXED_NAME}__content`;\nconst PREFIX_INNER_WRAPPER = `${PREFIXED_NAME}__inner`;\nconst PREFIX_HAS_H_SCROLL = MH.prefixName(\"has-h-scroll\");\nconst PREFIX_HAS_V_SCROLL = MH.prefixName(\"has-v-scroll\");\nconst PREFIX_USES_STICKY = MH.prefixName(\"uses-sticky\");\n\nlet mainWidget: SmoothScroll | null = null;\n\nconst configValidator: WidgetConfigValidatorObject<SmoothScrollConfig> = {\n  id: validateString,\n  className: validateStrList,\n  lag: validateNumber,\n};\n\ntype WrappersFor<K extends string> = {\n  [key in K]: HTMLElement;\n};\n\nconst createWrappers = <K extends string>(\n  element: HTMLElement,\n  // from outer-most to inner-most:\n  // [\n  //   key to use in the returned object,\n  //   classNames to add,\n  // ]\n  classNamesEntries: readonly [K, string[]][],\n): { wrappers: WrappersFor<K>; unwrapFn: () => void } => {\n  const wrapContentNow = (element: HTMLElement, classNames: string[]) =>\n    tryWrapContentNow(element, {\n      _classNames: classNames,\n      _required: true,\n      _requiredBy: \"SmoothScroll\",\n    });\n\n  let lastWrapper = element;\n  const result = {} as WrappersFor<K>;\n  let createdByUs: [HTMLElement, string[]][] = [];\n\n  const unwrapFn = () => {\n    for (const [wrapper, classNames] of createdByUs) {\n      unwrapContentNow(wrapper, classNames);\n    }\n    createdByUs = [];\n  };\n\n  for (const [key, classNames] of classNamesEntries) {\n    // Add generic lisn-wrapper class to allow ScrollWatcher to reuse it\n    const allClassNames = [...classNames, MC.PREFIX_WRAPPER];\n    let wrapper = getContentWrapper(lastWrapper, {\n      _classNames: allClassNames,\n    });\n\n    if (!wrapper) {\n      wrapper = wrapContentNow(lastWrapper, allClassNames);\n      createdByUs.push([wrapper, classNames]); // only remove the specific classes\n    }\n\n    lastWrapper = wrapper;\n    result[key] = wrapper;\n  }\n\n  return { wrappers: result, unwrapFn };\n};\n\n// XXX TODO children can use unique lag factor\nconst init = async (\n  widget: SmoothScroll,\n  scrollable: HTMLElement,\n  // props: ReturnType<typeof getScrollableProps>, XXX\n  config: SmoothScrollConfig | undefined,\n) => {\n  const docEl = MH.getDocElement();\n  const body = MH.getBody();\n  const defaultScrollable = getDefaultScrollingElement();\n  let needsSticky = true;\n  let root = scrollable;\n\n  if (scrollable === docEl || scrollable === body) {\n    scrollable = defaultScrollable;\n    root = body;\n    needsSticky = false;\n  }\n\n  const logger = debug\n    ? new debug.Logger({\n        name: `SmoothScroll-${formatAsString(scrollable)}`,\n        logAtCreation: { config, needsSticky },\n      })\n    : null;\n\n  if (needsSticky && !supportsSticky()) {\n    logError(\n      \"SmoothScroll on elements other than the document relies on \" +\n        \"position: sticky, but this browser does not support sticky.\",\n    );\n    return;\n  }\n\n  const scrollWatcher = ScrollWatcher.reuse({ [MC.S_DEBOUNCE_WINDOW]: 0 });\n  const sizeWatcher = SizeWatcher.reuse({ [MC.S_DEBOUNCE_WINDOW]: 0 });\n\n  await waitForMeasureTime();\n  const initialContentWidth = scrollable[MC.S_SCROLL_WIDTH];\n  const initialContentHeight = scrollable[MC.S_SCROLL_HEIGHT];\n  debug: logger?.debug5({\n    clientWidth: scrollable.clientWidth,\n    clientHeight: scrollable.clientHeight,\n    scrollWidth: initialContentWidth,\n    scrollHeight: initialContentHeight,\n  });\n\n  // We only care if it has horizontal/vertical scroll if we're using a custom\n  // scrollable, so no need to check otherwise.\n  const hasHScroll = needsSticky\n    ? isScrollable(scrollable, { axis: \"x\" })\n    : false;\n  const hasVScroll = needsSticky\n    ? isScrollable(scrollable, { axis: \"y\" })\n    : false;\n\n  // ----------\n\n  const setSizeVars = (\n    element: Element,\n    width: number,\n    height: number,\n    now = false,\n  ) => {\n    (now ? setNumericStyleJsVarsNow : setNumericStyleJsVars)(\n      element,\n      { width, height },\n      { _units: \"px\", _numDecimal: 2 },\n    );\n  };\n\n  // If there's a scroll or size change for the scrollable container, update the\n  // transforms and possibly the width/height of the content (if it uses sticky)\n  // .\n  const updatePropsOnScroll = (target: Element, scrollData: ScrollData) => {\n    updateTargetPosition(scrollData);\n\n    // If the scrollable scrolls horizontally we need to set a fixed width on\n    // the inner wrapper, and if it scrolls vertically we need to set a fixed\n    // height.\n    if (needsSticky) {\n      setSizeVars(\n        innerWrapper,\n        hasHScroll ? scrollData[MC.S_CLIENT_WIDTH] : NaN,\n        hasVScroll ? scrollData[MC.S_CLIENT_HEIGHT] : NaN,\n      );\n    }\n  };\n\n  // If content is resized, update the dummy overflow to match its size\n  const updatePropsOnResize = (target: Element, sizeData: SizeData) => {\n    setSizeVars(\n      dummy,\n      sizeData.border[MC.S_WIDTH],\n      sizeData.border[MC.S_HEIGHT],\n    );\n  };\n\n  // ----------\n\n  const currentPositions = { x: 0, y: 0 };\n  const targetPositions = MH.copyObject(currentPositions);\n\n  const updateTargetPosition = (scrollData: ScrollData) => {\n    for (const d of [\"x\", \"y\"] as const) {\n      const current = currentPositions[d];\n      const target = targetPositions[d];\n      const newTarget =\n        scrollData[d === \"x\" ? MC.S_SCROLL_LEFT : MC.S_SCROLL_TOP];\n\n      const isOngoing = current !== target;\n      targetPositions[d] = newTarget;\n\n      if (!isOngoing) {\n        animateTransforms(d);\n      }\n    }\n  };\n\n  const animateTransforms = async (d: \"x\" | \"y\"): Promise<void> => {\n    const lag = config?.lag ?? 1000; // XXX\n    debug: logger?.debug10(\n      `Starting animating ${d} transforms with lag ${lag}`,\n    );\n\n    let target = targetPositions[d];\n    let current = currentPositions[d];\n    const iterator = newCriticallyDampedAnimationIterator({\n      l: current,\n      lTarget: target,\n      lag,\n    });\n\n    while (({ l: current } = (await iterator.next(target)).value)) {\n      currentPositions[d] = current;\n      target = targetPositions[d];\n\n      setNumericStyleJsVars(\n        innerWrapper,\n        { [d]: -current },\n        { _prefix: \"offset-\", _units: \"px\", _numDecimal: 2 },\n      );\n\n      console.log(\n        \"XXX\",\n        JSON.stringify({\n          d,\n          current,\n          target,\n        }),\n      );\n\n      if (current === target) {\n        debug: logger?.debug10(`Done animating ${d} transforms`, target);\n        return;\n      }\n    }\n  };\n\n  // ----------\n\n  const addWatchers = () => {\n    // Track scroll in any direction as well as changes in border or content size\n    // of the element and its contents.\n    scrollWatcher.trackScroll(updatePropsOnScroll, {\n      threshold: 0,\n      scrollable,\n    });\n\n    // Track changes in content or border size of the inner content wrapper.\n    sizeWatcher.onResize(updatePropsOnResize, {\n      target: innerWrapper,\n      threshold: 0,\n    });\n  };\n\n  const removeWatchers = () => {\n    scrollWatcher.noTrackScroll(updatePropsOnScroll, scrollable);\n    sizeWatcher.offResize(updatePropsOnResize, innerWrapper);\n  };\n\n  // SETUP ------------------------------\n\n  await waitForMutateTime();\n  addClassesNow(root, PREFIX_ROOT);\n\n  // Wrap the contents in a fixed/sticky positioned wrapper and insert a dummy\n  // overflow element of the same size.\n  // [TODO v2]: Better way to centrally manage wrapping and wrapping of elements\n  const { wrappers, unwrapFn } = createWrappers(root, [\n    [\"o\", [PREFIX_OUTER_WRAPPER]],\n    [\"i\", [PREFIX_INNER_WRAPPER]],\n  ]);\n\n  const outerWrapper = wrappers.o;\n  const innerWrapper = wrappers.i;\n\n  if (needsSticky) {\n    setBooleanDataNow(root, PREFIX_HAS_H_SCROLL, hasHScroll);\n    setBooleanDataNow(root, PREFIX_HAS_V_SCROLL, hasVScroll);\n    setBooleanDataNow(root, PREFIX_USES_STICKY);\n  }\n\n  if (config?.id) {\n    outerWrapper.id = config.id;\n  }\n\n  if (config?.className) {\n    addClassesNow(outerWrapper, ...toArrayIfSingle(config.className));\n  }\n\n  const dummy = MH.createElement(\"div\");\n  addClassesNow(dummy, PREFIX_DUMMY);\n  // set its size now to prevent initial layout shifts\n  setSizeVars(dummy, initialContentWidth, initialContentHeight, true);\n  moveElementNow(dummy, { to: root, ignoreMove: true });\n\n  addWatchers();\n\n  widget.onDisable(() => {\n    removeWatchers();\n    // XXX TODO re-enable regular scrolling\n  });\n\n  widget.onEnable(() => {\n    addWatchers();\n    // XXX TODO re-enable smooth scrolling\n  });\n\n  widget.onDestroy(async () => {\n    await waitForMutateTime();\n\n    unwrapFn();\n    moveElementNow(dummy); // remove\n\n    removeClassesNow(root, PREFIX_ROOT);\n    delDataNow(root, PREFIX_HAS_H_SCROLL);\n    delDataNow(root, PREFIX_HAS_V_SCROLL);\n    delDataNow(root, PREFIX_USES_STICKY);\n  });\n};\n"],"mappings":"AAAA;AACA;AACA;;AAEA,OAAO,KAAKA,EAAE;AACd,OAAO,KAAKC,EAAE;AAEd,SAASC,oCAAoC;AAC7C,SAASC,cAAc;AACvB,SACEC,aAAa,EACbC,gBAAgB,EAChBC,iBAAiB,EACjBC,UAAU,EACVC,qBAAqB,EACrBC,wBAAwB;AAE1B,SACEC,cAAc,EACdC,iBAAiB,EACjBC,iBAAiB,EACjBC,gBAAgB;AAElB,SACEC,kBAAkB,EAClBC,iBAAiB;AAEnB,SAASC,QAAQ;AACjB,SAASC,eAAe;AACxB,SAASC,YAAY,EAAEC,0BAA0B;AACjD,SAASC,cAAc;AACvB,SACEC,eAAe,EACfC,cAAc,EACdC,cAAc;AAGhB,SAASC,aAAa;AACtB,SAASC,WAAW;AAEpB,SACEC,MAAM,EAENC,cAAc;AAGhB,OAAOC,KAAK;;AAEZ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO,MAAMC,YAAY,SAASH,MAAM,CAAC;EACvC;;EAEA;AACF;AACA;AACA;EACE,OAAOI,GAAGA,CAACC,UAAoB,EAAuB;IACpD,IAAI,CAACA,UAAU,EAAE;MACf,OAAOC,UAAU;IACnB;IAEA,IAAID,UAAU,KAAK9B,EAAE,CAACgC,aAAa,CAAC,CAAC,EAAE;MACrCF,UAAU,GAAG9B,EAAE,CAACiC,OAAO,CAAC,CAAC;IAC3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","ignoreList":[]}