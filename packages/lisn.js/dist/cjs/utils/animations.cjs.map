{"version":3,"file":"animations.cjs","names":["MC","_interopRequireWildcard","require","MH","_cssAlter","_domOptimize","e","t","WeakMap","r","n","__esModule","o","i","f","__proto__","default","has","get","set","hasOwnProperty","call","Object","defineProperty","getOwnPropertyDescriptor","_awaitAsyncGenerator","_OverloadYield","_wrapAsyncGenerator","AsyncGenerator","apply","arguments","resume","value","u","Promise","resolve","v","then","k","done","settle","reject","next","key","arg","_invoke","return","prototype","Symbol","asyncIterator","throw","d","_asyncIterator","iterator","AsyncFromSyncIterator","TypeError","AsyncFromSyncIteratorContinuation","s","waitForAnimationFrame","newPromise","onAnimationFrame","exports","onEveryAnimationFrame","callback","_iteratorAbruptCompletion","_didIteratorError","_iteratorError","_iterator","animationFrameIterator","_step","totalElapsed","elapsedSinceLast","shouldRepeat","err","_animationFrameIterator","startTime","previousTimeStamp","step","timeStamp","iterateAnimations","element","webAnimationCallback","legacyCallback","realtime","getData","prefixName","waitForMeasureTime","animation","getAnimations","waitForMutateTime","resetCssAnimationsNow","addClassesNow","PREFIX_ANIMATE_DISABLE","S_CLIENT_WIDTH","removeClassesNow"],"sources":["../../../src/ts/utils/animations.ts"],"sourcesContent":["/**\n * @module Utils\n */\n\nimport * as MC from \"@lisn/globals/minification-constants\";\nimport * as MH from \"@lisn/globals/minification-helpers\";\n\nimport {\n  addClassesNow,\n  removeClassesNow,\n  getData,\n} from \"@lisn/utils/css-alter\";\nimport {\n  waitForMeasureTime,\n  waitForMutateTime,\n} from \"@lisn/utils/dom-optimize\";\n\n/**\n * The callback is passed two arguments:\n * 1. The total elapsed time in milliseconds since the start\n * 2. The elapsed time in milliseconds since the previous frame\n *\n * The first time this callback is called both of these will be 0.\n *\n * The callback must return `true` if it wants to animate again on the next\n * frame and `false` if done.\n */\nexport type AnimationCallback = (\n  totalElapsed: number,\n  elapsedSinceLast: number,\n) => boolean;\n\n/**\n * Returns a promise that resolves at the next animation frame. Async/await\n * version of requestAnimationFrame.\n *\n * @returns The timestamp gotten from requestAnimationFrame\n *\n * @category Animations\n */\nexport const waitForAnimationFrame = async () =>\n  MH.newPromise<number>((resolve) => {\n    MH.onAnimationFrame(resolve);\n  });\n\n/**\n * Calls the given callback on every animation frame.\n *\n * The returned Promise resolves when the callback is done (returns `false`).\n *\n * @see {@link AnimationCallback}\n *\n * @since v1.2.0\n *\n * @category Animations\n */\nexport const onEveryAnimationFrame = async (callback: AnimationCallback) => {\n  for await (const [\n    totalElapsed,\n    elapsedSinceLast,\n  ] of animationFrameIterator()) {\n    const shouldRepeat = callback(totalElapsed, elapsedSinceLast);\n\n    if (!shouldRepeat) {\n      break;\n    }\n  }\n};\n\n/**\n * Generator version of {@link onEveryAnimationFrame}.\n *\n * Returns a new async iterator which yields the total elapsed time and elapsed\n * time since the last call on every animation frame.\n *\n * @example\n * ```javascript\n * for await (const [totalElapsed, elapsedSinceLast] of animationFrameIterator()) {\n *   // ... do something\n *   if (done) break;\n * }\n * ```\n *\n * @since v1.2.0\n *\n * @category Animations\n */\nexport async function* animationFrameIterator() {\n  let startTime: number, previousTimeStamp: number;\n\n  const step = async () => {\n    const timeStamp = await waitForAnimationFrame();\n    if (!startTime) {\n      startTime = timeStamp;\n      previousTimeStamp = timeStamp;\n    }\n\n    const totalElapsed = timeStamp - startTime;\n    const elapsedSinceLast = timeStamp - previousTimeStamp;\n    previousTimeStamp = timeStamp;\n\n    return [totalElapsed, elapsedSinceLast];\n  };\n\n  while (true) {\n    yield step();\n  }\n}\n\n/**\n * @param webAnimationCallback This function is called for each\n *                             {@link https://developer.mozilla.org/en-US/docs/Web/API/Animation | Animation}\n *                             on the element. It {@link waitForMeasureTime}\n *                             before reading the animations.\n * @param legacyCallback       This function is called if the browser does not\n *                             support the Web Animations API. It is called\n *                             after {@link waitForMutateTime} so it can safely\n *                             modify styles.\n * @param realtime             If true, then it does not\n *                             {@link waitForMeasureTime} or\n *                             {@link waitForMutateTime} and runs\n *                             synchronously.\n *\n * @category Animations\n */\nexport const iterateAnimations = async (\n  element: Element,\n  webAnimationCallback: (animation: Animation) => void,\n  legacyCallback: (element: Element) => void,\n  realtime = false,\n) => {\n  /* istanbul ignore next */ // jsdom doesn't support Web Animations\n  if (\n    \"getAnimations\" in element &&\n    getData(element, MH.prefixName(\"test-legacy\")) === null\n  ) {\n    if (!realtime) {\n      await waitForMeasureTime();\n    }\n\n    for (const animation of element.getAnimations()) {\n      webAnimationCallback(animation);\n    }\n\n    // Old browsers, no Animation API\n  } else {\n    if (!realtime) {\n      await waitForMutateTime();\n    }\n\n    legacyCallback(element);\n  }\n};\n\n/**\n * @ignore\n * @internal\n */\nexport const resetCssAnimationsNow = (element: Element) => {\n  addClassesNow(element, MC.PREFIX_ANIMATE_DISABLE); // cause it to reset\n  // If we remove the disable class immediately, then it will not have the\n  // effect to reset the animation, since the browser won't see any change in\n  // the classList at the start of the frame. So we ideally need to remove the\n  // disable class after the next paint. However, depending on the animation,\n  // and its state, disabling animation and waiting for the next animation\n  // frame may cause a visible glitch, so we need to force layout now.\n  /* eslint-disable-next-line @typescript-eslint/no-unused-expressions */\n  element[MC.S_CLIENT_WIDTH]; // forces layout\n\n  removeClassesNow(element, MC.PREFIX_ANIMATE_DISABLE);\n};\n"],"mappings":";;;;;;;AAIA,IAAAA,EAAA,GAAAC,uBAAA,CAAAC,OAAA;AACA,IAAAC,EAAA,GAAAF,uBAAA,CAAAC,OAAA;AAEA,IAAAE,SAAA,GAAAF,OAAA;AAKA,IAAAG,YAAA,GAAAH,OAAA;AAGkC,SAAAD,wBAAAK,CAAA,EAAAC,CAAA,6BAAAC,OAAA,MAAAC,CAAA,OAAAD,OAAA,IAAAE,CAAA,OAAAF,OAAA,YAAAP,uBAAA,YAAAA,CAAAK,CAAA,EAAAC,CAAA,SAAAA,CAAA,IAAAD,CAAA,IAAAA,CAAA,CAAAK,UAAA,SAAAL,CAAA,MAAAM,CAAA,EAAAC,CAAA,EAAAC,CAAA,KAAAC,SAAA,QAAAC,OAAA,EAAAV,CAAA,iBAAAA,CAAA,uBAAAA,CAAA,yBAAAA,CAAA,SAAAQ,CAAA,MAAAF,CAAA,GAAAL,CAAA,GAAAG,CAAA,GAAAD,CAAA,QAAAG,CAAA,CAAAK,GAAA,CAAAX,CAAA,UAAAM,CAAA,CAAAM,GAAA,CAAAZ,CAAA,GAAAM,CAAA,CAAAO,GAAA,CAAAb,CAAA,EAAAQ,CAAA,gBAAAP,CAAA,IAAAD,CAAA,gBAAAC,CAAA,OAAAa,cAAA,CAAAC,IAAA,CAAAf,CAAA,EAAAC,CAAA,OAAAM,CAAA,IAAAD,CAAA,GAAAU,MAAA,CAAAC,cAAA,KAAAD,MAAA,CAAAE,wBAAA,CAAAlB,CAAA,EAAAC,CAAA,OAAAM,CAAA,CAAAK,GAAA,IAAAL,CAAA,CAAAM,GAAA,IAAAP,CAAA,CAAAE,CAAA,EAAAP,CAAA,EAAAM,CAAA,IAAAC,CAAA,CAAAP,CAAA,IAAAD,CAAA,CAAAC,CAAA,WAAAO,CAAA,KAAAR,CAAA,EAAAC,CAAA;AAAA,SAAAkB,qBAAAnB,CAAA,eAAAoB,cAAA,CAAApB,CAAA;AAAA,SAAAqB,oBAAArB,CAAA,oCAAAsB,cAAA,CAAAtB,CAAA,CAAAuB,KAAA,OAAAC,SAAA;AAAA,SAAAF,eAAAtB,CAAA,QAAAG,CAAA,EAAAF,CAAA,WAAAwB,OAAAtB,CAAA,EAAAF,CAAA,cAAAG,CAAA,GAAAJ,CAAA,CAAAG,CAAA,EAAAF,CAAA,GAAAK,CAAA,GAAAF,CAAA,CAAAsB,KAAA,EAAAC,CAAA,GAAArB,CAAA,YAAAc,cAAA,EAAAQ,OAAA,CAAAC,OAAA,CAAAF,CAAA,GAAArB,CAAA,CAAAwB,CAAA,GAAAxB,CAAA,EAAAyB,IAAA,WAAA9B,CAAA,QAAA0B,CAAA,QAAApB,CAAA,gBAAAJ,CAAA,2BAAAG,CAAA,CAAA0B,CAAA,IAAA/B,CAAA,CAAAgC,IAAA,SAAAR,MAAA,CAAAlB,CAAA,EAAAN,CAAA,GAAAA,CAAA,GAAAD,CAAA,CAAAO,CAAA,EAAAN,CAAA,EAAAyB,KAAA,IAAAQ,MAAA,CAAA9B,CAAA,CAAA6B,IAAA,wBAAAhC,CAAA,gBAAAD,CAAA,IAAAyB,MAAA,UAAAzB,CAAA,gBAAAA,CAAA,IAAAkC,MAAA,UAAAlC,CAAA,gBAAAkC,OAAAlC,CAAA,EAAAI,CAAA,YAAAJ,CAAA,mBAAAG,CAAA,CAAA0B,OAAA,GAAAH,KAAA,EAAAtB,CAAA,EAAA6B,IAAA,8BAAA9B,CAAA,CAAAgC,MAAA,CAAA/B,CAAA,mBAAAD,CAAA,CAAA0B,OAAA,GAAAH,KAAA,EAAAtB,CAAA,EAAA6B,IAAA,YAAA9B,CAAA,GAAAA,CAAA,CAAAiC,IAAA,IAAAX,MAAA,CAAAtB,CAAA,CAAAkC,GAAA,EAAAlC,CAAA,CAAAmC,GAAA,IAAArC,CAAA,gBAAAsC,OAAA,aAAAvC,CAAA,EAAAI,CAAA,eAAAwB,OAAA,WAAAtB,CAAA,EAAAqB,CAAA,QAAApB,CAAA,KAAA8B,GAAA,EAAArC,CAAA,EAAAsC,GAAA,EAAAlC,CAAA,EAAAyB,OAAA,EAAAvB,CAAA,EAAA6B,MAAA,EAAAR,CAAA,EAAAS,IAAA,UAAAnC,CAAA,GAAAA,CAAA,GAAAA,CAAA,CAAAmC,IAAA,GAAA7B,CAAA,IAAAJ,CAAA,GAAAF,CAAA,GAAAM,CAAA,EAAAkB,MAAA,CAAAzB,CAAA,EAAAI,CAAA,gCAAAJ,CAAA,CAAAwC,MAAA,UAAAA,MAAA;AAAAlB,cAAA,CAAAmB,SAAA,sBAAAC,MAAA,IAAAA,MAAA,CAAAC,aAAA,uDAAArB,cAAA,CAAAmB,SAAA,CAAAL,IAAA,aAAApC,CAAA,gBAAAuC,OAAA,SAAAvC,CAAA,MAAAsB,cAAA,CAAAmB,SAAA,CAAAG,KAAA,aAAA5C,CAAA,gBAAAuC,OAAA,UAAAvC,CAAA,MAAAsB,cAAA,CAAAmB,SAAA,CAAAD,MAAA,aAAAxC,CAAA,gBAAAuC,OAAA,WAAAvC,CAAA;AAAA,SAAAoB,eAAApB,CAAA,EAAA6C,CAAA,SAAAf,CAAA,GAAA9B,CAAA,OAAAgC,CAAA,GAAAa,CAAA;AAAA,SAAAC,eAAA3C,CAAA,QAAAC,CAAA,EAAAH,CAAA,EAAAK,CAAA,EAAAN,CAAA,iCAAA0C,MAAA,KAAAzC,CAAA,GAAAyC,MAAA,CAAAC,aAAA,EAAArC,CAAA,GAAAoC,MAAA,CAAAK,QAAA,GAAA/C,CAAA,WAAAC,CAAA,aAAAG,CAAA,GAAAD,CAAA,CAAAF,CAAA,WAAAG,CAAA,CAAAW,IAAA,CAAAZ,CAAA,OAAAG,CAAA,aAAAF,CAAA,GAAAD,CAAA,CAAAG,CAAA,eAAA0C,qBAAA,CAAA5C,CAAA,CAAAW,IAAA,CAAAZ,CAAA,IAAAF,CAAA,sBAAAK,CAAA,6BAAA2C,SAAA;AAAA,SAAAD,sBAAA7C,CAAA,aAAA+C,kCAAA/C,CAAA,QAAAa,MAAA,CAAAb,CAAA,MAAAA,CAAA,SAAAyB,OAAA,CAAAO,MAAA,KAAAc,SAAA,CAAA9C,CAAA,+BAAAC,CAAA,GAAAD,CAAA,CAAA8B,IAAA,SAAAL,OAAA,CAAAC,OAAA,CAAA1B,CAAA,CAAAuB,KAAA,EAAAK,IAAA,WAAA5B,CAAA,aAAAuB,KAAA,EAAAvB,CAAA,EAAA8B,IAAA,EAAA7B,CAAA,iBAAA4C,qBAAA,YAAAA,CAAA7C,CAAA,SAAAgD,CAAA,GAAAhD,CAAA,OAAAC,CAAA,GAAAD,CAAA,CAAAiC,IAAA,KAAAY,qBAAA,CAAAP,SAAA,KAAAU,CAAA,QAAA/C,CAAA,QAAAgC,IAAA,WAAAA,CAAA,WAAAc,iCAAA,MAAA9C,CAAA,CAAAmB,KAAA,MAAA4B,CAAA,EAAA3B,SAAA,OAAAgB,MAAA,WAAAA,CAAArC,CAAA,QAAAC,CAAA,QAAA+C,CAAA,CAAAX,MAAA,oBAAApC,CAAA,GAAAwB,OAAA,CAAAC,OAAA,GAAAH,KAAA,EAAAvB,CAAA,EAAA8B,IAAA,UAAAiB,iCAAA,CAAA9C,CAAA,CAAAmB,KAAA,MAAA4B,CAAA,EAAA3B,SAAA,OAAAoB,KAAA,WAAAA,CAAAzC,CAAA,QAAAC,CAAA,QAAA+C,CAAA,CAAAX,MAAA,oBAAApC,CAAA,GAAAwB,OAAA,CAAAO,MAAA,CAAAhC,CAAA,IAAA+C,iCAAA,CAAA9C,CAAA,CAAAmB,KAAA,MAAA4B,CAAA,EAAA3B,SAAA,aAAAwB,qBAAA,CAAA7C,CAAA,KAflC;AACA;AACA;AAeA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAMA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,MAAMiD,qBAAqB,GAAG,MAAAA,CAAA,KACnCvD,EAAE,CAACwD,UAAU,CAAUxB,OAAO,IAAK;EACjChC,EAAE,CAACyD,gBAAgB,CAACzB,OAAO,CAAC;AAC9B,CAAC,CAAC;;AAEJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAVA0B,OAAA,CAAAH,qBAAA,GAAAA,qBAAA;AAWO,MAAMI,qBAAqB,GAAG,MAAOC,QAA2B,IAAK;EAAA,IAAAC,yBAAA;EAAA,IAAAC,iBAAA;EAAA,IAAAC,cAAA;EAAA;IAC1E,SAAAC,SAAA,GAAAf,cAAA,CAGKgB,sBAAsB,CAAC,CAAC,GAAAC,KAAA,EAAAL,yBAAA,KAAAK,KAAA,SAAAF,SAAA,CAAAzB,IAAA,IAAAH,IAAA,EAAAyB,yBAAA,UAAE;MAAA,MAHd,CACfM,YAAY,EACZC,gBAAgB,CACjB,GAAAF,KAAA,CAAArC,KAAA;MAAA;QACC,MAAMwC,YAAY,GAAGT,QAAQ,CAACO,YAAY,EAAEC,gBAAgB,CAAC;QAE7D,IAAI,CAACC,YAAY,EAAE;UACjB;QACF;MAAC;IACH;EAAC,SAAAC,GAAA;IAAAR,iBAAA;IAAAC,cAAA,GAAAO,GAAA;EAAA;IAAA;MAAA,IAAAT,yBAAA,IAAAG,SAAA,CAAArB,MAAA;QAAA,MAAAqB,SAAA,CAAArB,MAAA;MAAA;IAAA;MAAA,IAAAmB,iBAAA;QAAA,MAAAC,cAAA;MAAA;IAAA;EAAA;AACH,CAAC;;AAED;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAjBAL,OAAA,CAAAC,qBAAA,GAAAA,qBAAA;AAAA,SAkBuBM,sBAAsBA,CAAA;EAAA,OAAAM,uBAAA,CAAA7C,KAAA,OAAAC,SAAA;AAAA;AAsB7C;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAfA,SAAA4C,wBAAA;EAAAA,uBAAA,GAAA/C,mBAAA,CAtBO,aAAyC;IAC9C,IAAIgD,SAAiB,EAAEC,iBAAyB;IAEhD,MAAMC,IAAI,GAAG,MAAAA,CAAA,KAAY;MACvB,MAAMC,SAAS,GAAG,MAAMpB,qBAAqB,CAAC,CAAC;MAC/C,IAAI,CAACiB,SAAS,EAAE;QACdA,SAAS,GAAGG,SAAS;QACrBF,iBAAiB,GAAGE,SAAS;MAC/B;MAEA,MAAMR,YAAY,GAAGQ,SAAS,GAAGH,SAAS;MAC1C,MAAMJ,gBAAgB,GAAGO,SAAS,GAAGF,iBAAiB;MACtDA,iBAAiB,GAAGE,SAAS;MAE7B,OAAO,CAACR,YAAY,EAAEC,gBAAgB,CAAC;IACzC,CAAC;IAED,OAAO,IAAI,EAAE;MACX,MAAMM,IAAI,CAAC,CAAC;IACd;EACF,CAAC;EAAA,OAAAH,uBAAA,CAAA7C,KAAA,OAAAC,SAAA;AAAA;AAkBM,MAAMiD,iBAAiB,GAAG,MAAAA,CAC/BC,OAAgB,EAChBC,oBAAoD,EACpDC,cAA0C,EAC1CC,QAAQ,GAAG,KAAK,KACb;EACH,2BAA2B;EAC3B,IACE,eAAe,IAAIH,OAAO,IAC1B,IAAAI,iBAAO,EAACJ,OAAO,EAAE7E,EAAE,CAACkF,UAAU,CAAC,aAAa,CAAC,CAAC,KAAK,IAAI,EACvD;IACA,IAAI,CAACF,QAAQ,EAAE;MACb,MAAM,IAAAG,+BAAkB,EAAC,CAAC;IAC5B;IAEA,KAAK,MAAMC,SAAS,IAAIP,OAAO,CAACQ,aAAa,CAAC,CAAC,EAAE;MAC/CP,oBAAoB,CAACM,SAAS,CAAC;IACjC;;IAEA;EACF,CAAC,MAAM;IACL,IAAI,CAACJ,QAAQ,EAAE;MACb,MAAM,IAAAM,8BAAiB,EAAC,CAAC;IAC3B;IAEAP,cAAc,CAACF,OAAO,CAAC;EACzB;AACF,CAAC;;AAED;AACA;AACA;AACA;AAHAnB,OAAA,CAAAkB,iBAAA,GAAAA,iBAAA;AAIO,MAAMW,qBAAqB,GAAIV,OAAgB,IAAK;EACzD,IAAAW,uBAAa,EAACX,OAAO,EAAEhF,EAAE,CAAC4F,sBAAsB,CAAC,CAAC,CAAC;EACnD;EACA;EACA;EACA;EACA;EACA;EACA;EACAZ,OAAO,CAAChF,EAAE,CAAC6F,cAAc,CAAC,CAAC,CAAC;;EAE5B,IAAAC,0BAAgB,EAACd,OAAO,EAAEhF,EAAE,CAAC4F,sBAAsB,CAAC;AACtD,CAAC;AAAC/B,OAAA,CAAA6B,qBAAA,GAAAA,qBAAA","ignoreList":[]}