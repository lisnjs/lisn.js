{"version":3,"file":"overlays.js","names":["MC","MH","settings","addClasses","addClassesNow","setDataNow","setStylePropNow","moveElement","wrapScrollingContent","waitForElement","waitForMutateTime","logWarn","camelToKebabCase","objToStrKey","isScrollable","tryGetMainContentElement","fetchMainContentElement","newXWeakMap","getOverlay","userOptions","_overlays$get","options","tryGetOverlayOptions","overlays","get","_parent","_overlayKey","createOverlay","fetchOverlayOptions","canReuse","_id","_overlays$get2","existingOverlay","parentOf","overlay","createOnlyOverlay","sGet","set","id","isPercentageHOffset","includes","_style","left","right","isPercentageVOffset","top","bottom","needsContentWrapping","parentEl","axis","contentWrappingAllowed","position","S_ABSOLUTE","prefixName","to","newMap","_userOptions$data","_userOptions$id","style","getCssProperties","data","tryGetParent","parent","_data","getOverlayKey","_userOptions$data2","_userOptions$id2","fetchParent","finalCssProperties","merge","S_FIXED","isEmpty","userSuppliedParent","getBody","createElement","attr","keysOf","prop"],"sources":["../../../src/ts/utils/overlays.ts"],"sourcesContent":["/**\n * @module Utils\n */\n\nimport * as MC from \"@lisn/globals/minification-constants\";\nimport * as MH from \"@lisn/globals/minification-helpers\";\n\nimport { settings } from \"@lisn/globals/settings\";\n\nimport {\n  addClasses,\n  addClassesNow,\n  setDataNow,\n  setStylePropNow,\n} from \"@lisn/utils/css-alter\";\nimport { moveElement, wrapScrollingContent } from \"@lisn/utils/dom-alter\";\nimport { waitForElement } from \"@lisn/utils/dom-events\";\nimport { waitForMutateTime } from \"@lisn/utils/dom-optimize\";\nimport { logWarn } from \"@lisn/utils/log\";\nimport { camelToKebabCase, objToStrKey } from \"@lisn/utils/text\";\nimport {\n  isScrollable,\n  tryGetMainContentElement,\n  fetchMainContentElement,\n} from \"@lisn/utils/scroll\";\n\nimport { newXWeakMap } from \"@lisn/modules/x-map\";\n\n/**\n * @category Overlays\n * @interface\n */\nexport type OverlayOptions = {\n  /**\n   * The parent element to insert the overlay into.\n   *\n   * If not given, then:\n   * - if the overlay is to have a `position: fixed`, then `document.body` is used\n   * - otherwise,\n   *   {@link Watchers/ScrollWatcher.ScrollWatcher.fetchMainContentElement | ScrollWatcher.fetchMainContentElement} is\n   *   used\n   */\n  parent?: HTMLElement;\n\n  /**\n   * If set, then it will be assigned as the DOM element ID for the new\n   * overlay.\n   *\n   * Furthermore, the new overlay will be created and will not be saved for\n   * future reuse.\n   *\n   * By default, if `id` is not given, the overlay will be saved, and if\n   * {@link createOverlay} is called again with the same `style`, `data` and\n   * parent, the previous overlay is returned.\n   */\n  id?: string;\n\n  /**\n   * Every entry in this object will be set on the `style` of the new overlay.\n   *\n   * **IMPORTANT:** By default overlays are positioned absolutely, so if you need\n   * another positioning, override this here by setting a `position` key in\n   * `style`. If position is either \"absolute\" (by default or explicitly set) or\n   * \"fixed\", and none of `top` or `bottom` is given, `top: 0` is set; and\n   * similarly, if none of `left` or `right` is given, `left: 0` is set.\n   */\n  style?: Record<string, string>;\n\n  /**\n   * Every entry in this object will be set as a data attribute on the new\n   * overlay.\n   *\n   * Keys can be either kebab-case or camelCase (they will be converted if\n   * needed). Do _not_ include the \"data-\" prefix which will be added\n   * automatically. E.g. both \"foo-bar\" and \"fooBar\" will result in\n   * \"data-foo-bar\" being set.\n   */\n  data?: Record<string, string>;\n};\n\n/**\n * Returns an existing overlay for this specification. If the overlay was just\n * created it may not yet be attached to the DOM.\n *\n * @category Overlays\n */\nexport const getOverlay = (userOptions?: OverlayOptions) => {\n  const options = tryGetOverlayOptions(userOptions);\n  if (!options) {\n    return null;\n  }\n\n  return overlays.get(options._parent)?.get(options._overlayKey) || null;\n};\n\n/**\n * Creates a new overlay, and inserts it into the DOM as soon as\n * {@link waitForMutateTime} resolves, or returns an already existing matching\n * overlay.\n *\n * **Note** that if {@link OverlayOptions.id} is set, a new overlay will\n * _always_ be created.\n *\n * @category Overlays\n */\nexport const createOverlay = async (userOptions?: OverlayOptions) => {\n  const options = await fetchOverlayOptions(userOptions);\n  const canReuse = !options._id;\n\n  if (canReuse) {\n    const existingOverlay = overlays\n      .get(options._parent)\n      ?.get(options._overlayKey);\n\n    if (existingOverlay) {\n      if (!MH.parentOf(existingOverlay)) {\n        // not yet inserted into the DOM, so wait until it is\n        await waitForMutateTime();\n      }\n      return existingOverlay;\n    }\n  }\n\n  // Create a new one\n  const overlay = createOnlyOverlay(options);\n  if (canReuse) {\n    // Save it now before awating, so that concurrent requests to create the\n    // same one use it\n    overlays.sGet(options._parent).set(options._overlayKey, overlay);\n  } else {\n    overlay.id = options._id;\n  }\n\n  const isPercentageHOffset = MH.includes(\n    (options._style.left || \"\") + (options._style.right || \"\"),\n    \"%\",\n  );\n\n  const isPercentageVOffset = MH.includes(\n    (options._style.top || \"\") + (options._style.bottom || \"\"),\n    \"%\",\n  );\n\n  let needsContentWrapping = false;\n  let parentEl = options._parent;\n  if (isPercentageHOffset || isPercentageVOffset) {\n    needsContentWrapping =\n      (isPercentageHOffset && isScrollable(parentEl, { axis: \"x\" })) ||\n      (isPercentageVOffset && isScrollable(parentEl, { axis: \"y\" }));\n  }\n\n  if (needsContentWrapping) {\n    if (settings.contentWrappingAllowed) {\n      parentEl = await wrapScrollingContent(parentEl);\n    } else {\n      logWarn(\n        \"Percentage offset view trigger with scrolling root requires contentWrappingAllowed\",\n      );\n    }\n  }\n\n  if (options._style.position === MC.S_ABSOLUTE) {\n    // Ensure parent has non-static positioning\n    addClasses(parentEl, MH.prefixName(\"overlay-container\"));\n  }\n\n  await moveElement(overlay, { to: parentEl });\n\n  return overlay;\n};\n\n// ----------------------------------------\n\ntype OverlayOptionsInternal = {\n  _parent: HTMLElement;\n  _id: string;\n  _style: Record<string, string>;\n  _data: Record<string, string>;\n  _overlayKey: string;\n};\n\nconst overlays = newXWeakMap<HTMLElement, Map<string, HTMLElement>>(() =>\n  MH.newMap(),\n);\n\nconst tryGetOverlayOptions = (\n  userOptions: OverlayOptions | undefined,\n): OverlayOptionsInternal | null => {\n  const style = getCssProperties(userOptions?.style);\n  const data = userOptions?.data ?? {};\n  const parentEl = tryGetParent(userOptions?.parent, style.position);\n  if (!parentEl) {\n    return null;\n  }\n\n  return {\n    _parent: parentEl,\n    _id: userOptions?.id ?? \"\",\n    _style: style,\n    _data: data,\n    _overlayKey: getOverlayKey(style, data),\n  };\n};\n\nconst fetchOverlayOptions = async (\n  userOptions: OverlayOptions | undefined,\n): Promise<OverlayOptionsInternal> => {\n  const style = getCssProperties(userOptions?.style);\n  const data = userOptions?.data ?? {};\n  const parentEl = await fetchParent(userOptions?.parent, style.position);\n\n  return {\n    _parent: parentEl,\n    _id: userOptions?.id ?? \"\",\n    _style: style,\n    _data: data,\n    _overlayKey: getOverlayKey(style, data),\n  };\n};\n\nconst getOverlayKey = (\n  style: Record<string, string>,\n  data: Record<string, string>,\n) => objToStrKey(style) + \"|\" + objToStrKey(data);\n\nconst getCssProperties = (style: Record<string, string> | undefined) => {\n  const finalCssProperties: Record<string, string> = MH.merge(\n    { position: MC.S_ABSOLUTE }, // default\n    style,\n  );\n\n  if (\n    finalCssProperties.position === MC.S_ABSOLUTE ||\n    finalCssProperties.position === MC.S_FIXED\n  ) {\n    if (\n      MH.isEmpty(finalCssProperties.top) &&\n      MH.isEmpty(finalCssProperties.bottom)\n    ) {\n      finalCssProperties.top = \"0px\";\n    }\n\n    if (\n      MH.isEmpty(finalCssProperties.left) &&\n      MH.isEmpty(finalCssProperties.right)\n    ) {\n      finalCssProperties.left = \"0px\";\n    }\n  }\n\n  return finalCssProperties;\n};\n\nconst tryGetParent = (\n  userSuppliedParent: HTMLElement | undefined | null,\n  position: string,\n) =>\n  userSuppliedParent ??\n  (position === MC.S_FIXED ? MH.getBody() : tryGetMainContentElement());\n\nconst fetchParent = async (\n  userSuppliedParent: HTMLElement | undefined | null,\n  position: string,\n) =>\n  userSuppliedParent ??\n  (position === MC.S_FIXED\n    ? await waitForElement(MH.getBody)\n    : await fetchMainContentElement());\n\nconst createOnlyOverlay = (options: OverlayOptionsInternal) => {\n  const overlay = MH.createElement(\"div\");\n\n  addClassesNow(overlay, MH.prefixName(\"overlay\"));\n\n  const data = options._data;\n  for (const attr of MH.keysOf(data)) {\n    setDataNow(overlay, camelToKebabCase(attr), data[attr]);\n  }\n\n  const style = options._style;\n  for (const prop of MH.keysOf(style)) {\n    setStylePropNow(overlay, prop, style[prop]);\n  }\n\n  return overlay;\n};\n"],"mappings":"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","ignoreList":[]}